---
name: CI
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint / Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --frozen

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format
        run: uv run ruff format --check .

  build-firmware:
    name: Build firmware
    runs-on: ubuntu-latest
    env:
      ESP_IDF_VERSION: v5.5.1
      MICROPYTHON_VER: v1.27.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential cmake ninja-build flex bison gperf \
            ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --frozen

      - name: Cache MicroPython
        id: cache-micropython
        uses: actions/cache@v4
        with:
          path: firmware/micropython
          key: ${{ runner.os }}-micropython-${{ env.MICROPYTHON_VER }}-${{ hashFiles('.git/modules/firmware/micropython/HEAD') }}
          restore-keys: |
            ${{ runner.os }}-micropython-${{ env.MICROPYTHON_VER }}-

      - name: Clone MicroPython
        if: steps.cache-micropython.outputs.cache-hit != 'true'
        run: |
          mkdir -p firmware
          git clone --depth 1 --branch ${{ env.MICROPYTHON_VER }} \
            https://github.com/micropython/micropython.git firmware/micropython

      - name: Cache mpy-cross
        id: cache-mpy-cross
        uses: actions/cache@v4
        with:
          path: firmware/micropython/mpy-cross/build/mpy-cross
          key: ${{ runner.os }}-mpy-cross-${{ hashFiles('firmware/micropython/py/*.[ch]', 'firmware/micropython/mpy-cross/**/*.[ch]') }}
          restore-keys: |
            ${{ runner.os }}-mpy-cross-

      - name: Build mpy-cross
        if: steps.cache-mpy-cross.outputs.cache-hit != 'true'
        run: |
          cd firmware/micropython/mpy-cross
          make -j$(nproc)

      - name: Cache ESP-IDF
        id: cache-esp-idf
        uses: actions/cache@v4
        with:
          path: |
            ~/esp/idf
            ~/.espressif
          key: ${{ runner.os }}-esp-idf-${{ env.ESP_IDF_VERSION }}
          restore-keys: |
            ${{ runner.os }}-esp-idf-

      - name: Install ESP-IDF
        if: steps.cache-esp-idf.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/esp
          cd ~/esp
          git clone --recursive --branch ${{ env.ESP_IDF_VERSION }} \
            https://github.com/espressif/esp-idf.git idf
          cd idf
          ./install.sh esp32s3

      - name: Set up ESP-IDF environment
        run: |
          source ~/esp/idf/export.sh
          # Export all ESP-IDF environment variables to GitHub Actions environment
          echo "IDF_PATH=$IDF_PATH" >> $GITHUB_ENV
          echo "IDF_PYTHON_ENV_PATH=$IDF_PYTHON_ENV_PATH" >> $GITHUB_ENV
          # Capture the modified PATH
          echo "ESP_PATH=$PATH" >> $GITHUB_ENV

      - name: Build firmware
        env:
          MICROPY_MPYCROSS: ${{ github.workspace }}/firmware/micropython/mpy-cross/build/mpy-cross
          PATH: ${{ env.ESP_PATH }}
        run: |
          # Verify environment is set
          echo "IDF_PATH: $IDF_PATH"
          which idf.py
          make build

      - name: Collect build outputs
        if: success()
        run: |
          mkdir -p artifacts
          
          # Try primary location first
          if [ -d "firmware/build" ] && [ -n "$(ls -A firmware/build/*.bin 2>/dev/null)" ]; then
            cp -v firmware/build/*.bin artifacts/
          else
            # Fallback to board-specific build directory
            echo "Primary build directory not found, checking fallback..."
            BOARD_BUILD_DIR="firmware/micropython/ports/esp32/build-STRIPALERTS_S3"
            if [ -d "$BOARD_BUILD_DIR" ]; then
              cp -v "$BOARD_BUILD_DIR/micropython.bin" artifacts/firmware.bin
              cp -v "$BOARD_BUILD_DIR/partition_table/partition-table.bin" artifacts/
              cp -v "$BOARD_BUILD_DIR/bootloader/bootloader.bin" artifacts/
            else
              echo "Error: No build artifacts found"
              exit 1
            fi
          fi
          
          ls -la artifacts

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.sha }}
          path: artifacts/*.bin
          if-no-files-found: error
          retention-days: 30