---
name: CI
on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'frontend/**'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'frontend/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint / Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install uv
        uses: astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a # v4
        with:
          enable-cache: true
          python-version: "3.11"

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format
        run: uv run ruff format --check .

  build-firmware:
    name: Build firmware
    runs-on: ubuntu-latest
    env:
      ESP_IDF_VERSION: v5.5.1
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential cmake ninja-build flex bison gperf \
            ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

      - name: Install uv
        uses: astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a # v4
        with:
          enable-cache: true
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          uv sync --frozen || uv sync
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Cache mpy-cross
        id: cache-mpy-cross
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: micropython/mpy-cross/build/mpy-cross
          key: ${{ runner.os }}-mpy-cross-${{ hashFiles('micropython/mpy-cross/**/*') }}
          restore-keys: |
            ${{ runner.os }}-mpy-cross-

      - name: Build mpy-cross
        if: steps.cache-mpy-cross.outputs.cache-hit != 'true'
        run: |
          cd micropython/mpy-cross
          make -j$(nproc)

      - name: Cache ESP-IDF
        id: cache-esp-idf
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/esp/idf
            ~/.espressif
          key: ${{ runner.os }}-esp-idf-${{ env.ESP_IDF_VERSION }}
          restore-keys: |
            ${{ runner.os }}-esp-idf-

      - name: Install ESP-IDF
        if: steps.cache-esp-idf.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/esp
          cd ~/esp
          git clone --recursive --branch ${{ env.ESP_IDF_VERSION }} \
            https://github.com/espressif/esp-idf.git idf
          cd idf
          ./install.sh esp32s3

      - name: Build firmware
        env:
          MICROPY_MPYCROSS: ${{ github.workspace }}/micropython/mpy-cross/build/mpy-cross
        run: |
          source ~/esp/idf/export.sh
          # Verify environment is set
          echo "IDF_PATH: $IDF_PATH"
          which idf.py
          make build

      - name: Collect build outputs
        if: success()
        run: |
          mkdir -p artifacts

          # Try primary location first
          if [ -d "firmware/build" ] && [ -n "$(ls -A firmware/build/*.bin 2>/dev/null)" ]; then
            cp -v firmware/build/*.bin artifacts/
          else
            # Fallback to board-specific build directory
            echo "Primary build directory not found, checking fallback..."
            BOARD_BUILD_DIR="micropython/ports/esp32/build-STRIPALERTS_S3"
            if [ -d "$BOARD_BUILD_DIR" ]; then
              cp -v "$BOARD_BUILD_DIR/micropython.bin" artifacts/firmware.bin
              cp -v "$BOARD_BUILD_DIR/partition_table/partition-table.bin" artifacts/
              cp -v "$BOARD_BUILD_DIR/bootloader/bootloader.bin" artifacts/
            else
              echo "Error: No build artifacts found"
              exit 1
            fi
          fi

          ls -la artifacts

      - name: Upload firmware artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: firmware-${{ github.sha }}
          path: artifacts/*.bin
          if-no-files-found: error
          retention-days: 30
