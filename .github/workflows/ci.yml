name: CI

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'frontend/**'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'frontend/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint / Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.11"

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format
        run: uv run ruff format --check .

  build-firmware:
    name: Build firmware
    runs-on: ubuntu-latest
    env:
      ESP_IDF_VERSION: v5.5.1
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential cmake ninja-build flex bison gperf \
            ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          uv sync --frozen
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Cache mpy-cross
        id: cache-mpy-cross
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: micropython/mpy-cross/build/mpy-cross
          key: ${{ runner.os }}-mpy-cross-${{ hashFiles('micropython/mpy-cross/**/*') }}

      - name: Build mpy-cross
        if: steps.cache-mpy-cross.outputs.cache-hit != 'true'
        run: |
          cd micropython/mpy-cross
          make -j$(nproc)

      - name: Ensure mpy-cross is executable
        run: chmod +x micropython/mpy-cross/build/mpy-cross

      - name: Cache ESP-IDF
        id: cache-esp-idf
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: |
            ~/esp/idf
            ~/.espressif
          key: ${{ runner.os }}-esp-idf-${{ env.ESP_IDF_VERSION }}

      - name: Install ESP-IDF
        if: steps.cache-esp-idf.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/esp
          git clone --recursive --branch ${{ env.ESP_IDF_VERSION }} \
            https://github.com/espressif/esp-idf.git ~/esp/idf
          cd ~/esp/idf
          ./install.sh esp32s3

      - name: Build and Collect Firmware
        env:
          MICROPY_MPYCROSS: ${{ github.workspace }}/micropython/mpy-cross/build/mpy-cross
        run: |
          source ~/esp/idf/export.sh
          make build BOARD=STRIPALERTS_S3

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-STRIPALERTS_S3-${{ github.sha }}
          path: dist/
          if-no-files-found: error
          retention-days: 30
