---
name: CI
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  lint:
    name: Lint / Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        shell: bash
        run: |
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          uv sync --frozen
      - name: Ruff lint
        shell: bash
        run: |
          set -euo pipefail
          uv run ruff check .
      - name: Ruff format check
        shell: bash
        run: |
          set -euo pipefail
          uv run ruff format --check .
  build-firmware:
    name: Build firmware
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    env:
      ESP_IDF_PATH: /tmp/esp/idf
      ESP_TOOLS_PATH: /tmp/esp
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            git \
            build-essential \
            cmake \
            ninja-build \
            flex \
            bison \
            gperf \
            ccache \
            libffi-dev \
            libssl-dev \
            dfu-util \
            libusb-1.0-0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        shell: bash
        run: |
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          uv sync --frozen
      - name: Clone MicroPython
        shell: bash
        run: |
          set -euo pipefail
          cd firmware
          git clone --depth 1 https://github.com/micropython/micropython.git
      - name: Build mpy-cross
        shell: bash
        run: |
          set -euo pipefail
          cd firmware/micropython/mpy-cross
          make -j$(nproc) CC=gcc
      - name: Cache ESP-IDF + tools
        uses: actions/cache@v4
        with:
          path: |
            /tmp/esp/idf
            /tmp/esp
          key: ${{ runner.os }}-esp-idf-v5_5
          restore-keys: |
            ${{ runner.os }}-esp-idf-v5_5-
            ${{ runner.os }}-esp-idf-
      - name: Install ESP-IDF
        uses: espressif/install-esp-idf-action@v1
        with:
          version: v5.5
          path: /tmp/esp/idf
          tools-path: /tmp/esp
      - name: Sanity check idf.py
        shell: bash
        run: |
          set -euo pipefail
          command -v idf.py
          idf.py --version || true
      - name: Build firmware
        shell: bash
        env:
          MICROPY_MPYCROSS: ${{ github.workspace }}/firmware/micropython/mpy-cross/build/mpy-cross
        run: |
          set -euo pipefail
          make build
      - name: Collect build outputs
        if: success()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          # Use the artifacts collected by the build tool
          if [ -d firmware/build ] && [ "$(ls -A firmware/build/*.bin 2>/dev/null)" ]; then
            cp -v firmware/build/*.bin artifacts/
          else
            # Fallback to direct paths if tool failed to copy
            BOARD_BUILD_DIR="firmware/micropython/ports/esp32/build-STRIPALERTS_S3"
            [ -f "$BOARD_BUILD_DIR/micropython.bin" ] && cp -v "$BOARD_BUILD_DIR/micropython.bin" artifacts/firmware.bin
            [ -f "$BOARD_BUILD_DIR/partition_table/partition-table.bin" ] && cp -v "$BOARD_BUILD_DIR/partition_table/partition-table.bin" artifacts/
            [ -f "$BOARD_BUILD_DIR/bootloader/bootloader.bin" ] && cp -v "$BOARD_BUILD_DIR/bootloader/bootloader.bin" artifacts/
          fi
          ls -la artifacts
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v6
        with:
          name: firmware
          path: artifacts/*
          if-no-files-found: error
